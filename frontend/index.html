<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boxing + Strength</title>
  <style>
    :root{
      --bg0:#070912;
      --bg1:#0a0f1f;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --line: rgba(255,255,255,.10);
      --good: #22c55e;
      --bad: #ef4444;
      --shadow: 0 20px 90px rgba(0,0,0,.35);
      --shadow2: 0 12px 60px rgba(0,0,0,.28);
      --ease: cubic-bezier(.2,.8,.2,1);
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(99,102,241,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(20,184,166,.12), transparent 55%),
        radial-gradient(1000px 700px at 45% 90%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{ max-width:1200px; margin:0 auto; padding:22px 16px 30px; }

    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 14px;
      border:1px solid var(--line);
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width: 260px; }
    .logo{
      width:46px; height:46px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(20,184,166,.85));
      box-shadow: 0 20px 80px rgba(99,102,241,.18);
      display:grid; place-items:center;
      font-weight:900;
    }
    .brand h1{ margin:0; font-size:16px; letter-spacing:.2px }
    .sub{ margin-top:2px; color:var(--muted); font-size:12.5px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background: rgba(0,0,0,.25); color: var(--muted); font-size:12px;
    }
    .dot{
      width:9px; height:9px; border-radius:99px;
      background: var(--bad);
      box-shadow: 0 0 0 3px rgba(239,68,68,.12);
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    button,input,select,textarea{ font:inherit; color:var(--text); outline:none; }
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      padding:10px 12px;
      border-radius: 14px;
      display:inline-flex; align-items:center; gap:10px;
      transition: transform .18s var(--ease), background .18s var(--ease), border-color .18s var(--ease);
      user-select:none;
      backdrop-filter: blur(12px);
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.16); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(20,184,166,.85));
      border-color: rgba(99,102,241,.35);
      box-shadow: 0 18px 70px rgba(99,102,241,.14);
    }
    .btn.danger{ border-color: rgba(239,68,68,.32); background: rgba(239,68,68,.10); }
    .btn.ghost{ background: rgba(255,255,255,.03); }

    .grid{ display:grid; grid-template-columns: 1.05fr .95fr; gap:14px; margin-top:14px; align-items:start; }
    .panel{
      border:1px solid var(--line);
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      overflow:hidden;
      position:relative;
    }
    .ph{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .ph h2{ margin:0; font-size:13px; letter-spacing:.22px; color: rgba(255,255,255,.88); }
    .hint{ color: var(--muted); font-size:12px; }
    .pb{ padding:14px 16px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    .field{ flex:1; min-width:160px; }
    label{ display:block; color:var(--muted); font-size:12px; margin:0 0 6px; }
    input,select,textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      padding:10px 12px;
      transition: border-color .18s var(--ease), background .18s var(--ease);
    }
    textarea{ min-height: 86px; resize:none; }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(99,102,241,.48);
      box-shadow: 0 0 0 4px rgba(99,102,241,.12);
      background: rgba(0,0,0,.28);
    }

    .list{ display:flex; flex-direction:column; gap:10px; margin-top:12px; max-height: 520px; overflow:auto; padding-right: 6px; }
    .list::-webkit-scrollbar{ width:10px; }
    .list::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius:999px; border:2px solid rgba(0,0,0,0); background-clip: padding-box; }

    .card{
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 18px;
      padding:12px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      transition: transform .18s var(--ease), border-color .18s var(--ease), background .18s var(--ease);
      cursor:pointer;
    }
    .card:hover{ transform: translateY(-2px); background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.16); }
    .card.active{ border-color: rgba(99,102,241,.40); box-shadow: 0 0 0 4px rgba(99,102,241,.12); }

    .meta{ display:flex; flex-direction:column; gap:6px; min-width: 200px; }
    .titleLine{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.84);
      font-size:12px; white-space:nowrap;
    }
    .mini{ color: var(--muted); font-size:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .modeTag{ border-color: rgba(20,184,166,.28); }
    .modeTag.strength{ border-color: rgba(99,102,241,.28); }
    .modeTag.hybrid{ border-color: rgba(255,255,255,.16); }

    .kpis{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .kpi{
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      padding:12px;
      transition: transform .18s var(--ease);
    }
    .kpi:hover{ transform: translateY(-1px); }
    .kpi .lbl{ color: var(--muted); font-size:12px; }
    .kpi .val{ margin-top:6px; font-size:22px; font-weight:900; letter-spacing:.2px; }

    .seg{
      display:inline-flex;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(0,0,0,.22);
    }
    .seg button{
      border:0;
      padding:8px 12px;
      background: transparent;
      cursor:pointer;
      color: rgba(255,255,255,.72);
      transition: background .18s var(--ease), color .18s var(--ease);
    }
    .seg button.active{
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
    }

    .toast{
      display:none;
      margin-top:10px;
      border:1px solid var(--line);
      border-radius: 16px;
      padding:10px 12px;
      background: rgba(0,0,0,.22);
      animation: pop .35s var(--ease);
    }
    .toast.ok{ border-color: rgba(34,197,94,.35); }
    .toast.err{ border-color: rgba(239,68,68,.35); }
    @keyframes pop{ from{ transform: translateY(-6px); opacity:0 } to{ transform:none; opacity:1 } }

    .divider{ height:1px; background: rgba(255,255,255,.07); margin:12px 0; }

    .exRow{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding:10px 10px;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      transition: transform .18s var(--ease), background .18s var(--ease);
    }
    .exRow:hover{ transform: translateY(-1px); background: rgba(255,255,255,.05); }
    .exName{ font-weight: 850; }
    .exSub{ margin-top:2px; color: var(--muted); font-size:12px; }
    .iconBtn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 12px;
      padding:8px 10px;
      transition: transform .18s var(--ease), background .18s var(--ease);
    }
    .iconBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }
    .iconBtn.danger{ border-color: rgba(239,68,68,.32); background: rgba(239,68,68,.10); }

    /* Session view */
    .sessionHeader{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .sessionTitle{
      display:flex; flex-direction:column; gap:6px;
      min-width: 240px;
    }
    .sessionTitle b{ font-size:14px; letter-spacing:.2px; }
    .timerBox{
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      padding:12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .timerBig{
      font-size:28px;
      font-weight:950;
      letter-spacing:.8px;
    }
    .timerMeta{
      color: var(--muted);
      font-size:12px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <div class="logo">BX</div>
        <div>
          <h1>Boxing + Strength</h1>
          <div class="sub">
            <span class="chip"><span class="dot" id="apiDot"></span><span id="apiState">API‚Ä¶</span></span>
            <span class="chip"><code>/api</code> via proxy</span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnRefresh">‚ü≥ Refresh</button>
        <button class="btn primary" id="btnNew">Ôºã New Session</button>
      </div>
    </div>

    <!-- VIEW: LIST -->
    <div id="viewList">
      <div class="grid">
        <!-- LEFT -->
        <section class="panel">
          <div class="ph">
            <h2>üìí Sessions</h2>
            <div class="hint" id="status">‚Äî</div>
          </div>
          <div class="pb">

            <div class="row">
              <div class="field">
                <label>Mode</label>
                <select id="filterMode">
                  <option value="">All</option>
                  <option value="boxing">boxing</option>
                  <option value="strength">strength</option>
                  <option value="hybrid">hybrid</option>
                </select>
              </div>
              <div class="field">
                <label>Intensity</label>
                <select id="filterIntensity">
                  <option value="">All</option>
                  <option value="low">low</option>
                  <option value="medium">medium</option>
                  <option value="high">high</option>
                </select>
              </div>
              <div class="field">
                <label>Date</label>
                <input id="searchDate" type="date" />
              </div>
              <button class="btn danger" id="btnReset">Reset</button>
            </div>

            <div class="toast" id="toast"></div>

            <div class="list" id="sessionList"></div>

            <div class="mini" style="margin-top:10px;">
              üí° Clique une session ‚Üí <b>Open</b> (tu rentres dans la s√©ance). Tout est stock√© en MySQL.
            </div>
          </div>
        </section>

        <!-- RIGHT -->
        <aside class="panel">
          <div class="ph">
            <h2>‚ö° Dashboard</h2>
            <div class="hint">Boxe ‚Ä¢ Muscu ‚Ä¢ Hybride</div>
          </div>
          <div class="pb">

            <div class="kpis">
              <div class="kpi">
                <div class="lbl">Total sessions</div>
                <div class="val" id="kpiCount">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="lbl">Total minutes</div>
                <div class="val" id="kpiMinutes">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="lbl">Avg / session</div>
                <div class="val" id="kpiAvg">‚Äî</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="mini">
              ‚úÖ Pour enregistrer un entra√Ænement complet : cr√©e une session puis clique <b>Open</b>.<br>
              Tu auras dans la s√©ance : ajout exercices + timers (timed + rounds boxe).
            </div>

          </div>
        </aside>

      </div>
    </div>

    <!-- VIEW: SESSION -->
    <div id="viewSession" style="display:none; margin-top:14px;">
      <section class="panel">
        <div class="sessionHeader">
          <div class="sessionTitle">
            <b id="sessTitle">Session</b>
            <div class="mini" id="sessMeta">‚Äî</div>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
            <span class="pill" id="sessModeChip">‚Äî</span>
            <button class="btn ghost" id="btnBack">‚Üê Back</button>
            <button class="btn danger" id="btnDeleteSession">Delete</button>
          </div>
        </div>

        <div class="pb">
          <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <!-- LEFT: add + timers -->
            <div class="panel" style="border-radius:20px;">
              <div class="ph">
                <h2>‚ûï Add training</h2>
                <div class="hint">in this session</div>
              </div>
              <div class="pb">

                <div class="seg" style="margin-bottom:12px;">
                  <button id="tabBox" class="active">ü•ä Boxing rounds</button>
                  <button id="tabStr">üí™ Strength</button>
                  <button id="tabTim">‚è± Timed</button>
                </div>

                <!-- BOXING -->
                <div id="formBox">
                  <div class="row">
                    <div class="field">
                      <label>Name</label>
                      <input id="bxName" placeholder="Ex: Bag work / Shadow / Spar drills" />
                    </div>
                    <div class="field" style="min-width:140px;flex:.6">
                      <label>Rounds</label>
                      <input id="bxRounds" type="number" min="1" value="6" />
                    </div>
                  </div>
                  <div class="row" style="margin-top:10px;">
                    <div class="field" style="min-width:140px;flex:.6">
                      <label>Round (sec)</label>
                      <input id="bxRoundSec" type="number" min="30" value="180" />
                    </div>
                    <div class="field" style="min-width:140px;flex:.6">
                      <label>Rest (sec)</label>
                      <input id="bxRestSec" type="number" min="0" value="60" />
                    </div>
                    <div class="field">
                      <label>Focus</label>
                      <select id="bxFocus">
                        <option value="technique" selected>technique</option>
                        <option value="cardio">cardio</option>
                        <option value="power">power</option>
                        <option value="footwork">footwork</option>
                      </select>
                    </div>
                  </div>

                  <div class="divider"></div>

                  <div class="timerBox">
                    <div>
                      <div class="timerBig" id="bxTimerText">03:00</div>
                      <div class="timerMeta" id="bxTimerMeta">Ready ‚Ä¢ Round 1/6</div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                      <button class="btn" id="bxStart">‚ñ∂ Start</button>
                      <button class="btn" id="bxReset">‚Ü∫ Reset</button>
                      <button class="btn primary" id="btnAddBox">Ôºã Save</button>
                    </div>
                  </div>

                  <div class="mini" style="margin-top:10px;">
                    üí° Le timer ‚ÄúRounds‚Äù alterne <b>Round</b> et <b>Rest</b>. ‚ÄúSave‚Äù enregistre la config dans la s√©ance.
                  </div>
                </div>

                <!-- STRENGTH -->
                <div id="formStr" style="display:none;">
                  <div class="row">
                    <div class="field">
                      <label>Name</label>
                      <input id="stName" placeholder="Ex: Bench press / Squat / Pull-ups" />
                    </div>
                    <div class="field" style="min-width:140px;flex:.6">
                      <label>Sets</label>
                      <input id="stSets" type="number" min="1" value="4" />
                    </div>
                    <div class="field" style="min-width:140px;flex:.6">
                      <label>Reps</label>
                      <input id="stReps" type="number" min="1" value="8" />
                    </div>
                  </div>

                  <div class="row" style="margin-top:10px;">
                    <div class="field" style="min-width:160px;flex:.8">
                      <label>Weight</label>
                      <input id="stWeight" type="number" step="0.5" min="0" placeholder="Ex: 60" />
                    </div>

                    <div class="field" style="min-width:160px;flex:.6">
                      <label>Unit</label>
                      <select id="stUnit">
                        <option value="kg" selected>kg</option>
                        <option value="lb">lb</option>
                      </select>
                    </div>

                    <div class="field" style="min-width:160px;flex:.6">
                      <label>Rest (sec)</label>
                      <input id="stRest" type="number" min="0" value="90" />
                    </div>

                    <button class="btn primary" id="btnAddStr">Ôºã Save</button>
                  </div>

                  <div class="mini" id="stPreview" style="margin-top:8px;">
                    Tip: tu peux suivre kg ou lbs.
                  </div>
                </div>

                <!-- TIMED -->
                <div id="formTim" style="display:none;">
                  <div class="row">
                    <div class="field">
                      <label>Name</label>
                      <input id="tmName" placeholder="Ex: Jump rope / Row / Bike" />
                    </div>
                    <div class="field" style="min-width:140px;flex:.6">
                      <label>Duration (sec)</label>
                      <input id="tmDur" type="number" min="10" value="600" />
                    </div>
                    <div class="field" style="min-width:160px;flex:.6">
                      <label>Mode</label>
                      <select id="tmMode">
                        <option value="countdown" selected>countdown</option>
                        <option value="stopwatch">stopwatch</option>
                      </select>
                    </div>
                  </div>

                  <div class="divider"></div>

                  <div class="timerBox">
                    <div>
                      <div class="timerBig" id="tmTimerText">10:00</div>
                      <div class="timerMeta" id="tmTimerMeta">Ready ‚Ä¢ countdown</div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                      <button class="btn" id="tmStart">‚ñ∂ Start</button>
                      <button class="btn" id="tmReset">‚Ü∫ Reset</button>
                      <button class="btn primary" id="btnAddTim">Ôºã Save</button>
                    </div>
                  </div>

                  <div class="mini" style="margin-top:10px;">
                    üí° ‚ÄúStopwatch‚Äù = compte vers le haut. ‚ÄúSave‚Äù enregistre la dur√©e r√©elle (ou duration si countdown).
                  </div>
                </div>

                <div class="toast" id="toast2" style="margin-top:12px;"></div>
              </div>
            </div>

            <!-- RIGHT: exercises -->
            <div class="panel" style="border-radius:20px;">
              <div class="ph">
                <h2>üì¶ Exercises</h2>
                <div class="hint"><span class="chip">count <b id="exCount">0</b></span></div>
              </div>
              <div class="pb">
                <div class="list" id="exList" style="max-height: 520px;"></div>
              </div>
            </div>

          </div>
        </div>
      </section>
    </div>

  </div>

  <!-- Modal new session -->
  <div id="backdrop" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,.55); backdrop-filter: blur(10px); z-index:99; align-items:center; justify-content:center; padding:16px;">
    <div style="width:min(840px,100%); border:1px solid var(--line); background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)); border-radius:24px; box-shadow: var(--shadow); overflow:hidden;">
      <div style="padding:14px 14px; display:flex; justify-content:space-between; align-items:center; gap:10px; border-bottom:1px solid rgba(255,255,255,.07);">
        <b>Ôºã New session</b>
        <button class="btn danger" id="btnClose">Esc ¬∑ Close</button>
      </div>
      <div style="padding:14px 14px;">
        <div class="row">
          <div class="field">
            <label>Date</label>
            <input id="mDate" type="date"/>
          </div>
          <div class="field">
            <label>Start time (optional)</label>
            <input id="mTime" type="time"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label>Mode</label>
            <select id="mMode">
              <option value="boxing" selected>boxing</option>
              <option value="strength">strength</option>
              <option value="hybrid">hybrid</option>
            </select>
          </div>
          <div class="field">
            <label>Intensity</label>
            <select id="mIntensity">
              <option value="low">low</option>
              <option value="medium" selected>medium</option>
              <option value="high">high</option>
            </select>
          </div>
          <div class="field">
            <label>Duration (min) optional</label>
            <input id="mDuration" type="number" min="1" placeholder="leave empty to ignore"/>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Notes</label>
          <textarea id="mNotes" placeholder="Focus, combos, PRs, feelings..."></textarea>
        </div>

        <div class="row" style="margin-top:12px; justify-content:flex-end;">
          <button class="btn" id="btnToday">Today</button>
          <button class="btn primary" id="btnCreate">Create</button>
        </div>

        <div class="mini" style="margin-top:8px;">
          Apr√®s cr√©ation : clique <b>Open</b> pour entrer dans la s√©ance et ajouter tes entra√Ænements + timers.
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function pad(n){ return String(n).padStart(2,"0"); }
  function toDateInputValue(d = new Date()){
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function fmtFR(dateStr){
    const d = new Date(dateStr);
    if (isNaN(d)) return String(dateStr || "");
    return d.toLocaleDateString("fr-FR");
  }
  function fmtMMSS(totalSec){
    totalSec = Math.max(0, Math.floor(Number(totalSec || 0)));
    const m = Math.floor(totalSec / 60);
    const s = totalSec % 60;
    return `${pad(m)}:${pad(s)}`;
  }
  function showToast(type, msg, which="toast"){
    const el = $(which);
    el.className = "toast " + (type === "ok" ? "ok" : "err");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> el.style.display="none", 2400);
  }

  async function apiHealth(){
    try{
      const r = await fetch("/api/health");
      const ok = r.ok;
      $("apiState").textContent = ok ? "API OK" : "API KO";
      $("apiDot").style.background = ok ? "var(--good)" : "var(--bad)";
      $("apiDot").style.boxShadow = ok ? "0 0 0 3px rgba(34,197,94,.12)" : "0 0 0 3px rgba(239,68,68,.12)";
    }catch{
      $("apiState").textContent = "API OFF";
      $("apiDot").style.background = "var(--bad)";
    }
  }

  // --- API
  async function refreshSessions(){
    $("status").textContent = "Loading‚Ä¶";
    const r = await fetch("/api/sessions");
    if (!r.ok){
      showToast("err", `GET /api/sessions ‚Üí ${r.status}`);
      $("status").textContent = "API error";
      return [];
    }
    return await r.json();
  }

  async function createSession(payload){
    const r = await fetch("/api/sessions", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload),
    });
    if (!r.ok){
      const t = await r.text();
      console.log(t);
      showToast("err", `POST /api/sessions ‚Üí ${r.status}`);
      return null;
    }
    return await r.json();
  }

  async function deleteSession(id){
    const r = await fetch(`/api/sessions/${id}`, { method:"DELETE" });
    if (!r.ok){
      showToast("err", `DELETE /api/sessions/${id} ‚Üí ${r.status}`);
      return false;
    }
    return true;
  }

  async function fetchExercises(sid){
    const r = await fetch(`/api/sessions/${sid}/exercises`);
    if (!r.ok){
      showToast("err", `GET /api/sessions/${sid}/exercises ‚Üí ${r.status}`, "toast2");
      return [];
    }
    return await r.json();
  }

  async function addExercise(sid, payload){
    const r = await fetch(`/api/sessions/${sid}/exercises`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload),
    });
    if (!r.ok){
      const t = await r.text();
      console.log(t);
      showToast("err", `Add exercise failed (${r.status})`, "toast2");
      return false;
    }
    return true;
  }

  async function deleteExercise(eid){
    const r = await fetch(`/api/session_exercises/${eid}`, { method:"DELETE" });
    if (!r.ok){
      showToast("err", `Delete exercise failed (${r.status})`, "toast2");
      return false;
    }
    return true;
  }

  // --- State
  let allSessions = [];
  let listFiltered = [];
  let selectedId = null;
  let selectedSession = null;
  let view = "list"; // list | session

  function modeChip(mode){
    const m = (mode || "boxing").toLowerCase();
    if (m === "strength") return `<span class="pill modeTag strength">üí™ strength</span>`;
    if (m === "hybrid") return `<span class="pill modeTag hybrid">‚ö° hybrid</span>`;
    return `<span class="pill modeTag">ü•ä boxing</span>`;
  }

  function setView(v){
    view = v;
    $("viewList").style.display = (v === "list") ? "block" : "none";
    $("viewSession").style.display = (v === "session") ? "block" : "none";
    if (v === "list"){
      stopAllTimers();
    }
  }

  function applyView(){
    let rows = [...allSessions];

    const fm = $("filterMode").value;
    if (fm) rows = rows.filter(s => (s.mode || "").toLowerCase() === fm);

    const fi = $("filterIntensity").value;
    if (fi) rows = rows.filter(s => (s.intensity || "").toLowerCase() === fi);

    const sd = $("searchDate").value;
    if (sd){
      rows = rows.filter(s => {
        const iso = new Date(s.date).toISOString().slice(0,10);
        return iso === sd;
      });
    }

    listFiltered = rows;

    // KPIs
    const minutes = allSessions.reduce((sum,s)=> sum + Number(s.duration_min || 0), 0);
    $("kpiCount").textContent = allSessions.length;
    $("kpiMinutes").textContent = minutes;
    $("kpiAvg").textContent = allSessions.length ? Math.round(minutes / allSessions.length) : 0;

    $("status").textContent = `${rows.length} shown / ${allSessions.length} total`;

    renderSessions(rows);
  }

  function renderSessions(rows){
    const list = $("sessionList");
    list.innerHTML = "";
    if (!rows.length){
      const e = document.createElement("div");
      e.className = "mini";
      e.style.padding = "10px 6px";
      e.textContent = "No session yet. Click ‚ÄúNew Session‚Äù.";
      list.appendChild(e);
      return;
    }

    for (const s of rows){
      const c = document.createElement("div");
      c.className = "card";
      const intensity = (s.intensity || "medium").toLowerCase();
      const it = `<span class="pill">üî• ${intensity}</span>`;
      const dur = s.duration_min ? `<span class="pill">‚è± ${s.duration_min}m</span>` : `<span class="pill">‚è± ‚Äî</span>`;
      const time = s.start_time ? `<span class="pill">üïí ${String(s.start_time).slice(0,5)}</span>` : "";

      c.innerHTML = `
        <div class="meta">
          <div class="titleLine">
            <span class="pill">#${s.id}</span>
            <span>${fmtFR(s.date)}</span>
          </div>
          <div class="mini">
            ${modeChip(s.mode)}
            ${it}
            ${dur}
            ${time}
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" data-open="${s.id}">Open</button>
          <button class="btn danger" data-del="${s.id}">Delete</button>
        </div>
      `;

      c.querySelector("[data-open]").addEventListener("click", async (e)=>{
        e.stopPropagation();
        await openSession(Number(e.target.dataset.open));
      });

      c.querySelector("[data-del]").addEventListener("click", async (e)=>{
        e.stopPropagation();
        const id = Number(e.target.dataset.del);
        if (!confirm(`Delete session #${id}?`)) return;
        const ok = await deleteSession(id);
        if (ok){
          showToast("ok", `Session #${id} deleted ‚úÖ`);
          await refresh();
        }
      });

      list.appendChild(c);
    }
  }

  async function refresh(){
    allSessions = await refreshSessions();
    applyView();
  }

  // --- Session view
  async function openSession(id){
    selectedId = id;
    selectedSession = allSessions.find(s=>s.id===id) || null;
    if (!selectedSession){
      showToast("err","Session not found.");
      return;
    }
    $("sessTitle").textContent = `Session #${selectedSession.id} ‚Ä¢ ${fmtFR(selectedSession.date)}`;
    const time = selectedSession.start_time ? `üïí ${String(selectedSession.start_time).slice(0,5)}` : "üïí ‚Äî";
    const dur = selectedSession.duration_min ? `‚è± ${selectedSession.duration_min}m` : "‚è± ‚Äî";
    const it = `üî• ${(selectedSession.intensity || "medium")}`;
    $("sessMeta").innerHTML = `${modeChip(selectedSession.mode)} <span class="pill">${it}</span> <span class="pill">${dur}</span> <span class="pill">${time}</span>`;
    $("sessModeChip").textContent = (selectedSession.mode || "boxing");

    setView("session");
    setTab("box");
    resetBoxTimerUI();
    resetTimedTimerUI();
    await loadAndRenderExercises();
  }

  $("btnBack").addEventListener("click", ()=>{
    setView("list");
  });

  $("btnDeleteSession").addEventListener("click", async ()=>{
    if (!selectedId) return;
    if (!confirm(`Delete session #${selectedId}?`)) return;
    const ok = await deleteSession(selectedId);
    if (ok){
      showToast("ok", `Session #${selectedId} deleted ‚úÖ`);
      selectedId = null;
      selectedSession = null;
      setView("list");
      await refresh();
    }
  });

  function exLine(ex){
    const t = ex.type;
    if (t === "boxing_rounds"){
      const r = ex.rounds ?? "‚Äî";
      const rs = ex.round_sec ?? "‚Äî";
      const rest = ex.rest_sec ?? "‚Äî";
      const f = ex.focus ? ` ‚Ä¢ ${ex.focus}` : "";
      return `ü•ä ${r} rounds ‚Ä¢ ${rs}s / rest ${rest}s${f}`;
    }
    if (t === "strength"){
      const sets = ex.sets ?? "‚Äî";
      const reps = ex.reps ?? "‚Äî";
      const wv = ex.weight_value != null ? ex.weight_value : "";
      const wu = ex.weight_unit ? ex.weight_unit : "";
      const rest = ex.rest_sec != null ? ` ‚Ä¢ rest ${ex.rest_sec}s` : "";
      const w = (wv !== "") ? ` ‚Ä¢ ${wv}${wu}` : "";
      return `üí™ ${sets}√ó${reps}${w}${rest}`;
    }
    if (t === "timed"){
      const d = ex.duration_sec ?? "‚Äî";
      return `‚è± ${d}s`;
    }
    return t;
  }

  async function loadAndRenderExercises(){
    if (!selectedId) return;
    const rows = await fetchExercises(selectedId);
    $("exCount").textContent = String(rows.length);

    const list = $("exList");
    list.innerHTML = "";
    if (!rows.length){
      list.innerHTML = `<div class="mini" style="padding:8px 0;">No exercises yet ‚Äî add one on the left.</div>`;
      return;
    }
    for (const ex of rows){
      const el = document.createElement("div");
      el.className = "exRow";
      el.innerHTML = `
        <div>
          <div class="exName">${ex.name}</div>
          <div class="exSub">${exLine(ex)}</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <span class="pill">#${ex.id}</span>
          <button class="iconBtn danger" data-del="${ex.id}">üóëÔ∏è</button>
        </div>
      `;
      el.querySelector("[data-del]").addEventListener("click", async ()=>{
        if (!confirm(`Delete exercise #${ex.id}?`)) return;
        const ok = await deleteExercise(ex.id);
        if (ok){
          showToast("ok","Exercise deleted ‚úÖ","toast2");
          await loadAndRenderExercises();
        }
      });
      list.appendChild(el);
    }
  }

  // Tabs
  function setTab(t){
    $("tabBox").classList.remove("active");
    $("tabStr").classList.remove("active");
    $("tabTim").classList.remove("active");
    $("formBox").style.display = "none";
    $("formStr").style.display = "none";
    $("formTim").style.display = "none";

    if (t === "box"){
      $("tabBox").classList.add("active");
      $("formBox").style.display = "block";
      resetBoxTimerUI();
    } else if (t === "str"){
      $("tabStr").classList.add("active");
      $("formStr").style.display = "block";
    } else {
      $("tabTim").classList.add("active");
      $("formTim").style.display = "block";
      resetTimedTimerUI();
    }
  }
  $("tabBox").addEventListener("click", ()=> setTab("box"));
  $("tabStr").addEventListener("click", ()=> setTab("str"));
  $("tabTim").addEventListener("click", ()=> setTab("tim"));

  // --- Strength preview
  function updateStrengthPreview(){
    const w = $("stWeight").value;
    const u = $("stUnit").value;
    if (!w){
      $("stPreview").textContent = "Tip: tu peux suivre kg ou lbs.";
      return;
    }
    const val = Number(w);
    if (Number.isNaN(val)) return;
    const kg = (u === "lb") ? (val * 0.45359237) : val;
    $("stPreview").textContent = `Preview: ${val}${u} ‚âà ${kg.toFixed(2)}kg.`;
  }
  $("stWeight").addEventListener("input", updateStrengthPreview);
  $("stUnit").addEventListener("change", updateStrengthPreview);

  // --- Add boxing rounds (save)
  $("btnAddBox").addEventListener("click", async ()=>{
    if (!selectedId) return showToast("err","Select a session first.","toast2");
    const name = ($("bxName").value.trim() || "Boxing rounds");
    const payload = {
      type: "boxing_rounds",
      name,
      rounds: Number($("bxRounds").value || 6),
      round_sec: Number($("bxRoundSec").value || 180),
      rest_sec: Number($("bxRestSec").value || 60),
      focus: $("bxFocus").value
    };
    const ok = await addExercise(selectedId, payload);
    if (ok){
      $("bxName").value = "";
      showToast("ok","Saved ‚úÖ","toast2");
      await loadAndRenderExercises();
    }
  });

  // --- Add strength (save)
  $("btnAddStr").addEventListener("click", async ()=>{
    if (!selectedId) return showToast("err","Select a session first.","toast2");
    const name = $("stName").value.trim();
    if (!name) return showToast("err","Name required.","toast2");
    const payload = {
      type: "strength",
      name,
      sets: Number($("stSets").value || 4),
      reps: Number($("stReps").value || 8),
      rest_sec: Number($("stRest").value || 90),
      weight_value: $("stWeight").value ? Number($("stWeight").value) : null,
      weight_unit: $("stWeight").value ? $("stUnit").value : null
    };
    const ok = await addExercise(selectedId, payload);
    if (ok){
      $("stName").value = "";
      showToast("ok","Saved ‚úÖ","toast2");
      await loadAndRenderExercises();
    }
  });

  // --- Add timed (save)
  $("btnAddTim").addEventListener("click", async ()=>{
    if (!selectedId) return showToast("err","Select a session first.","toast2");
    const name = ($("tmName").value.trim() || "Timed");
    const mode = $("tmMode").value;
    let dur;
    if (mode === "stopwatch"){
      dur = Math.max(1, Math.floor(timedTimer.elapsedSec));
    } else {
      // countdown: save configured duration (or remaining if ended)
      const cfg = Number($("tmDur").value || 600);
      dur = Math.max(1, Math.floor(cfg));
    }
    const payload = { type: "timed", name, duration_sec: dur };
    const ok = await addExercise(selectedId, payload);
    if (ok){
      $("tmName").value = "";
      showToast("ok",`Saved (${dur}s) ‚úÖ`,"toast2");
      await loadAndRenderExercises();
    }
  });

  // Filters
  $("filterMode").addEventListener("change", applyView);
  $("filterIntensity").addEventListener("change", applyView);
  $("searchDate").addEventListener("change", applyView);
  $("btnReset").addEventListener("click", ()=>{
    $("filterMode").value = "";
    $("filterIntensity").value = "";
    $("searchDate").value = "";
    applyView();
    showToast("ok","Filters reset ‚úÖ");
  });

  // Modal
  function openModal(){
    $("backdrop").style.display = "flex";
    $("mDate").value = toDateInputValue();
    $("mTime").value = "";
    $("mMode").value = "boxing";
    $("mIntensity").value = "medium";
    $("mDuration").value = "";
    // NOTE: on ne reset PAS mNotes si d√©j√† en train d‚Äô√©crire (√ßa √©vite les surprises)
    // Mais si tu veux reset √† chaque fois, d√©commente :
    // $("mNotes").value = "";
  }
  function closeModal(){ $("backdrop").style.display = "none"; }

  $("btnNew").addEventListener("click", ()=>{
    // reset propre quand on ouvre via bouton
    $("mNotes").value = "";
    openModal();
  });
  $("btnClose").addEventListener("click", closeModal);
  $("backdrop").addEventListener("click", (e)=>{ if (e.target === $("backdrop")) closeModal(); });
  $("btnToday").addEventListener("click", ()=> $("mDate").value = toDateInputValue());

  $("btnCreate").addEventListener("click", async ()=>{
    const payload = {
      date: $("mDate").value || toDateInputValue(),
      start_time: $("mTime").value || null,
      mode: $("mMode").value || "boxing",
      intensity: $("mIntensity").value || "medium",
      duration_min: $("mDuration").value ? Number($("mDuration").value) : null,
      notes: ($("mNotes").value || "").trim() || null
    };
    const created = await createSession(payload);
    if (!created) return;
    closeModal();
    showToast("ok","Session created ‚úÖ");
    await refresh();
    await openSession(created.id);
  });

  // Actions
  $("btnRefresh").addEventListener("click", async ()=>{
    await refresh();
    await apiHealth();
  });

  // --- FIX: raccourcis clavier qui cassaient les notes
  function isTyping(){
    const el = document.activeElement;
    if (!el) return false;
    const tag = (el.tagName || "").toLowerCase();
    if (tag === "input" || tag === "textarea" || tag === "select") return true;
    if (el.isContentEditable) return true;
    return false;
  }

  window.addEventListener("keydown", (e)=>{
    if (isTyping()) return; // ‚úÖ plus de reset pendant que tu tapes
    if (e.key === "Escape") closeModal();
    if (e.key === "n" || e.key === "N") { $("mNotes").value=""; openModal(); }
    if (e.key === "r" || e.key === "R") refresh();
  });

  // ----------------------------
  // Timers
  // ----------------------------
  function stopAllTimers(){
    stopBoxTimer();
    stopTimedTimer();
  }

  // --- Boxing rounds timer (round/rest loop)
  const boxTimer = {
    running:false,
    interval:null,
    phase:"ready", // ready | round | rest | done
    roundIndex:1,
    remaining:180,
    cfg:{ rounds:6, roundSec:180, restSec:60 }
  };

  function readBoxCfg(){
    boxTimer.cfg.rounds = Math.max(1, Number($("bxRounds").value || 6));
    boxTimer.cfg.roundSec = Math.max(10, Number($("bxRoundSec").value || 180));
    boxTimer.cfg.restSec = Math.max(0, Number($("bxRestSec").value || 60));
  }

  function resetBoxTimerUI(){
    readBoxCfg();
    if (boxTimer.running) return;
    if (boxTimer.phase === "ready" || boxTimer.phase === "done"){
      $("bxTimerText").textContent = fmtMMSS(boxTimer.cfg.roundSec);
      $("bxTimerMeta").textContent = `Ready ‚Ä¢ Round 1/${boxTimer.cfg.rounds}`;
    }
  }

  function setBoxUI(){
    $("bxTimerText").textContent = fmtMMSS(boxTimer.remaining);
    const total = boxTimer.cfg.rounds;
    const ri = Math.min(boxTimer.roundIndex, total);
    if (boxTimer.phase === "round"){
      $("bxTimerMeta").textContent = `ROUND ‚Ä¢ ${ri}/${total}`;
    } else if (boxTimer.phase === "rest"){
      $("bxTimerMeta").textContent = `REST ‚Ä¢ next ${Math.min(ri+1,total)}/${total}`;
    } else if (boxTimer.phase === "done"){
      $("bxTimerMeta").textContent = `Done ‚úÖ ‚Ä¢ ${total} rounds`;
    } else {
      $("bxTimerMeta").textContent = `Ready ‚Ä¢ Round 1/${total}`;
    }
    $("bxStart").textContent = boxTimer.running ? "‚è∏ Pause" : "‚ñ∂ Start";
  }

  function stopBoxTimer(){
    boxTimer.running = false;
    if (boxTimer.interval) clearInterval(boxTimer.interval);
    boxTimer.interval = null;
    $("bxStart").textContent = "‚ñ∂ Start";
  }

  function resetBoxTimer(){
    stopBoxTimer();
    readBoxCfg();
    boxTimer.phase = "ready";
    boxTimer.roundIndex = 1;
    boxTimer.remaining = boxTimer.cfg.roundSec;
    setBoxUI();
  }

  function nextBoxPhase(){
    const { rounds, roundSec, restSec } = boxTimer.cfg;

    if (boxTimer.phase === "ready"){
      boxTimer.phase = "round";
      boxTimer.roundIndex = 1;
      boxTimer.remaining = roundSec;
      return;
    }

    if (boxTimer.phase === "round"){
      if (restSec > 0){
        boxTimer.phase = "rest";
        boxTimer.remaining = restSec;
      } else {
        // no rest -> jump to next round / done
        if (boxTimer.roundIndex >= rounds){
          boxTimer.phase = "done";
          boxTimer.remaining = 0;
        } else {
          boxTimer.roundIndex += 1;
          boxTimer.phase = "round";
          boxTimer.remaining = roundSec;
        }
      }
      return;
    }

    if (boxTimer.phase === "rest"){
      if (boxTimer.roundIndex >= rounds){
        boxTimer.phase = "done";
        boxTimer.remaining = 0;
      } else {
        boxTimer.roundIndex += 1;
        boxTimer.phase = "round";
        boxTimer.remaining = roundSec;
      }
      return;
    }
  }

  function startBoxTimer(){
    if (boxTimer.running) return;
    readBoxCfg();
    if (boxTimer.phase === "done") resetBoxTimer();
    if (boxTimer.phase === "ready") {
      boxTimer.remaining = boxTimer.cfg.roundSec;
      nextBoxPhase();
    }
    boxTimer.running = true;
    setBoxUI();
    boxTimer.interval = setInterval(()=>{
      if (!boxTimer.running) return;
      boxTimer.remaining -= 1;
      if (boxTimer.remaining <= 0){
        boxTimer.remaining = 0;
        nextBoxPhase();
        if (boxTimer.phase === "done"){
          setBoxUI();
          stopBoxTimer();
          return;
        }
      }
      setBoxUI();
    }, 1000);
  }

  $("bxStart").addEventListener("click", ()=>{
    if (boxTimer.running){
      stopBoxTimer();
      setBoxUI();
    } else {
      startBoxTimer();
    }
  });
  $("bxReset").addEventListener("click", resetBoxTimer);

  // update boxing timer UI if config changes (only if not running)
  ["bxRounds","bxRoundSec","bxRestSec"].forEach(id=>{
    $(id).addEventListener("change", ()=>{ if (!boxTimer.running) resetBoxTimerUI(); });
  });

  // --- Timed timer (countdown / stopwatch)
  const timedTimer = {
    running:false,
    interval:null,
    mode:"countdown",
    remainingSec:600,
    elapsedSec:0,
    lastTick:null
  };

  function readTimedCfg(){
    timedTimer.mode = $("tmMode").value;
    const cfg = Math.max(10, Number($("tmDur").value || 600));
    if (!timedTimer.running){
      if (timedTimer.mode === "countdown"){
        timedTimer.remainingSec = cfg;
        timedTimer.elapsedSec = 0;
      } else {
        timedTimer.remainingSec = cfg; // unused in stopwatch
        // keep elapsed
      }
    }
  }

  function setTimedUI(){
    const mode = $("tmMode").value;
    timedTimer.mode = mode;

    if (mode === "countdown"){
      $("tmTimerText").textContent = fmtMMSS(timedTimer.remainingSec);
      $("tmTimerMeta").textContent = timedTimer.running ? "Running ‚Ä¢ countdown" : "Ready ‚Ä¢ countdown";
    } else {
      $("tmTimerText").textContent = fmtMMSS(timedTimer.elapsedSec);
      $("tmTimerMeta").textContent = timedTimer.running ? "Running ‚Ä¢ stopwatch" : "Ready ‚Ä¢ stopwatch";
    }
    $("tmStart").textContent = timedTimer.running ? "‚è∏ Pause" : "‚ñ∂ Start";
  }

  function stopTimedTimer(){
    timedTimer.running = false;
    if (timedTimer.interval) clearInterval(timedTimer.interval);
    timedTimer.interval = null;
    timedTimer.lastTick = null;
    setTimedUI();
  }

  function resetTimedTimerUI(){
    stopTimedTimer();
    const mode = $("tmMode").value;
    const cfg = Math.max(10, Number($("tmDur").value || 600));
    if (mode === "countdown"){
      timedTimer.remainingSec = cfg;
      timedTimer.elapsedSec = 0;
    } else {
      timedTimer.elapsedSec = 0;
      timedTimer.remainingSec = cfg;
    }
    setTimedUI();
  }

  function startTimedTimer(){
    if (timedTimer.running) return;
    const mode = $("tmMode").value;
    const cfg = Math.max(10, Number($("tmDur").value || 600));

    timedTimer.running = true;
    timedTimer.lastTick = Date.now();
    // ensure init
    if (mode === "countdown" && timedTimer.remainingSec <= 0) timedTimer.remainingSec = cfg;

    setTimedUI();
    timedTimer.interval = setInterval(()=>{
      if (!timedTimer.running) return;
      const now = Date.now();
      const dt = Math.floor((now - timedTimer.lastTick) / 1000);
      if (dt <= 0) return;
      timedTimer.lastTick = now;

      if (mode === "countdown"){
        timedTimer.remainingSec -= dt;
        if (timedTimer.remainingSec <= 0){
          timedTimer.remainingSec = 0;
          stopTimedTimer();
          showToast("ok","Timer finished ‚úÖ","toast2");
        }
      } else {
        timedTimer.elapsedSec += dt;
      }
      setTimedUI();
    }, 250);
  }

  $("tmStart").addEventListener("click", ()=>{
    if (timedTimer.running){
      stopTimedTimer();
    } else {
      startTimedTimer();
    }
  });
  $("tmReset").addEventListener("click", resetTimedTimerUI);
  $("tmMode").addEventListener("change", resetTimedTimerUI);
  $("tmDur").addEventListener("change", ()=>{
    if (!timedTimer.running) resetTimedTimerUI();
  });

  // Filters etc init
  $("filterMode").value = "";
  $("filterIntensity").value = "";
  $("searchDate").value = "";

  // INIT
  apiHealth();
  refresh();
  setView("list");
  resetBoxTimerUI();
  resetTimedTimerUI();

</script>
</body>
</html>
